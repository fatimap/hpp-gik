<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>hpp-gik: Example I</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('a00002.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>Example I </h1>  </div>
</div>
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="intro_sec"></a>
Introduction</h2>
<p>In this basic example, a motion for the center of the right hand is planned while projection of the center of mass on the ground and the feet's positions are maintained static.</p>
<h2><a class="anchor" id="code_sec"></a>
Code</h2>
<p>Set a sampling period: 5ms second is the value used on HRP2</p>
<div class="fragment"><pre class="fragment">        samplingPeriod = 5e-3;
</pre></div><p>Assuming that we have already constructed a CjrlHumanoidDynamicRobot object in halfsitting configuration and for which we have stored a pointer <code>robot</code>, create a standing robot: </p>
<div class="fragment"><pre class="fragment">                standingRobot = <span class="keyword">new</span> <a class="code" href="a00043.html" title="Wrapper for a jrlHumanoidDynamicRobot, support polygon and related information.">ChppGikStandingRobot</a> ( *robot );
</pre></div> <dl class="note"><dt><b>Note:</b></dt><dd>The degrees of freedom of the joints of the robot need to be bounded with actual values. If left to 0, the robot will not move.</dd></dl>
<p>Create a Gik solver </p>
<div class="fragment"><pre class="fragment">                <a class="code" href="a00040.html" title="Compute the joints updates for a hierarchy of simultaneous tasks.">ChppGikSolver</a> gikSolver(*robot);
</pre></div><p>Select the root of the robot at the right foot (reduces computation complexity) </p>
<div class="fragment"><pre class="fragment">                gikSolver.rootJoint(*robot-&gt;rightAnkle());
</pre></div><p>Create an empty motion (optional) </p>
<div class="fragment"><pre class="fragment">                <a class="code" href="a00055.html" title="Defines the motion of a robot along time.">ChppRobotMotion</a> solutionMotion(robot, 0.0 , samplingPeriod);
        <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00025.html#ad42c70b06fdda7014746a4be61325380">vector3d</a> ZMPworPla;<span class="comment">//planned ZMP in absolute frame</span>
        <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00025.html#ad42c70b06fdda7014746a4be61325380">vector3d</a> ZMPwstPla;<span class="comment">//Planned ZMP in robot waist frame</span>
        <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00025.html#ad42c70b06fdda7014746a4be61325380">vector3d</a> ZMPworObs;<span class="comment">//Observed ZMP in absolute frame</span>
        <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00025.html#ad42c70b06fdda7014746a4be61325380">vector3d</a> ZMPwstObs;<span class="comment">//Observed ZMP in robot waist frame</span>
        ZMPworPla = com; <span class="comment">// the ZMP is planned to remain at its inital position</span>
</pre></div><p>Create the constraints defing the tasks. <br/>
 First priority: Foot on the ground </p>
<div class="fragment"><pre class="fragment">                <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00025.html#ad42c70b06fdda7014746a4be61325380">vector3d</a> localPoint;
        localPoint[0] = 0.0;
        localPoint[1] = 0.0;
        localPoint[2] = 0.0;
        CjrlJoint&amp; nsfJoint = *(robot-&gt;leftAnkle());
        <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00023.html#a211846ce7e4e1babf086b2d54bc34e1b">matrix4d</a> nsfTransform = nsfJoint.currentTransformation();
        <a class="code" href="a00050.html" title="Specify a 3D position constraint on a point of the robot.">ChppGikTransformationConstraint</a> nsfc(*robot, nsfJoint, localPoint, nsfTransform);
</pre></div><p>Second priority: static Center of Mass </p>
<div class="fragment"><pre class="fragment">                <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00025.html#ad42c70b06fdda7014746a4be61325380">vector3d</a> com = robot-&gt;positionCenterOfMass();
        <a class="code" href="a00006.html" title="Specify a full or partial position constraint on the center of mass.">ChppGikComConstraint</a> comc(*robot, com[0], com[1]);
</pre></div><p>Third priority: A position constraint on a point in the right wrist frame </p>
<div class="fragment"><pre class="fragment">                <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00023.html#a211846ce7e4e1babf086b2d54bc34e1b">matrix4d</a> curT=  robot-&gt;rightWrist()-&gt;currentTransformation();
        CjrlJoint&amp; rwJoint = *(robot-&gt;rightWrist());
        robot-&gt;rightHand()-&gt;getCenter(localPoint);
        <a class="code" href="a00032.html" title="Specify a 3D position constraint on a point of the robot.">ChppGikPositionConstraint</a> pc(*robot,rwJoint,localPoint, curT*localPoint);
</pre></div><p> Stack the constraints in a vector </p>
<div class="fragment"><pre class="fragment">                std::vector&lt;CjrlGikStateConstraint*&gt; stack;
        stack.push_back(&amp;nsfc);
        stack.push_back(&amp;comc);
        stack.push_back(&amp;pc);
</pre></div><p>Build the weights used in solving the pseudo inverse kinematics </p>
<div class="fragment"><pre class="fragment">                <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00019.html#aae58ddf3e4db6ecec278b41e6c958bbd">vectorN</a> activated =  standingRobot-&gt;maskFactory()-&gt;wholeBodyMask();<span class="comment">// active joints</span>
        <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00019.html#aae58ddf3e4db6ecec278b41e6c958bbd">vectorN</a> weights = standingRobot-&gt;maskFactory()-&gt;weightsDoubleSupport(); <span class="comment">//With these weights, the more mass a joint is lifting the less it&#39;s used</span>
        <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00019.html#aae58ddf3e4db6ecec278b41e6c958bbd">vectorN</a> combined = weights;
        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0;i&lt;combined.size();i++)
            combined(i) *= activated(i);
        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0;i&lt;6;i++)
            combined(i) = 0.0; <span class="comment">// the absolute trnasformation (freeflyer) of the robot is not controlled</span>
</pre></div><p>Set the weights in the solver </p>
<div class="fragment"><pre class="fragment">                gikSolver.weights(combined);
</pre></div><p>Start the loop where we continuously change the desired target position of the hand, thus generating a motion: </p>
<div class="fragment"><pre class="fragment">                <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00025.html#ad42c70b06fdda7014746a4be61325380">vector3d</a> p;
        <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00023.html#a211846ce7e4e1babf086b2d54bc34e1b">matrix4d</a> waistTransform, inverseWaistTransform;
        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j&lt; 500;j++)
{
</pre></div><p> Change the target position for the hand slightly: </p>
<div class="fragment"><pre class="fragment">            p = pc-&gt;worldTarget();
    p[0] += 0.001;
    pc-&gt;worldTarget(p);
</pre></div><p> Attempt solve with a single one step: Prepare the constraints (jacobian and value computation) </p>
<div class="fragment"><pre class="fragment">            gikSolver.prepare(stack);
</pre></div><p> Solve </p>
<div class="fragment"><pre class="fragment">            gikSolver.solve( stack );
</pre></div><p> Apply solution to robot </p>
<div class="fragment"><pre class="fragment">            standingRobot-&gt;updateRobot(gikSolver.solutionRootPose(), gikSolver.solutionJointConfiguration(), samplingPeriod);
</pre></div><p> Store the computed sample (optional) </p>
<div class="fragment"><pre class="fragment">        <span class="comment">//compute planned and observed ZMP in absolute and waist frames</span>
            ZMPworObs = gikSolver.zeroMomentumPoint();
    waistTransform = robot-&gt;waist()-&gt;currentTransformation();
    <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00023.html#abb22b9ea31cdf69524ed55c7b7e55bb0">MAL_S4x4_INVERSE</a>(waistTransform,inverseWaistTransform,<span class="keywordtype">double</span>);
    <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00023.html#afb2b7bbf3bc6d3a383e7ac6b99fbc8f8">MAL_S4x4_C_eq_A_by_B</a>(ZMPwstObs,inverseWaistTransform,ZMPworObs);
    <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00023.html#afb2b7bbf3bc6d3a383e7ac6b99fbc8f8">MAL_S4x4_C_eq_A_by_B</a>(ZMPwstPla,inverseWaistTransform,ZMPworPla);

    motionsample.configuration = gikSolver.currentConfiguration();
    motionsample.velocity = gikSolver.currentVelocity();
    motionsample.acceleration = gikSolver.currentAcceleration();
    motionsample.rootpose = gikSolver.solutionRootPose();
    motionsample.ZMPwstPla = ZMPwstPla;
    motionsample.ZMPwstObs = ZMPwstObs;
    motionsample.ZMPworPla = ZMPworPla;
    motionsample.ZMPworObs = ZMPworObs;
        
    solutionMotion.appendSample(motionsample);
</pre></div><div class="fragment"><pre class="fragment">}
</pre></div> </div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Friends</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</body>
</html>
